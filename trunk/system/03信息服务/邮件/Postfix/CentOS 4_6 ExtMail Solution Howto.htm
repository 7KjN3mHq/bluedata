<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<!-- saved from url=(0051)http://www.extmail.org/docs/extmail_solution_linux/ -->
<HTML><HEAD><TITLE>CentOS 4.6 ExtMail Solution Howto</TITLE>
<META http-equiv=Content-Type content="text/html; charset=utf-8">
<STYLE>.line {
	BORDER-RIGHT: #ccc 1px solid; PADDING-RIGHT: 5px; BORDER-TOP: #ccc 1px solid; PADDING-LEFT: 5px; PADDING-BOTTOM: 5px; BORDER-LEFT: #ccc 1px solid; PADDING-TOP: 5px; BORDER-BOTTOM: #ccc 1px solid
}
.sm_title {
	FONT-WEIGHT: bold
}
PRE {
	PADDING-RIGHT: 5px; PADDING-LEFT: 5px; PADDING-BOTTOM: 5px; PADDING-TOP: 5px
}
BODY {
	FONT-SIZE: 14px
}
H3 {
	PADDING-RIGHT: 2px; PADDING-LEFT: 2px; PADDING-BOTTOM: 2px; PADDING-TOP: 2px; BACKGROUND-COLOR: #ccc
}
IMG {
	BORDER-RIGHT: 0px; BORDER-TOP: 0px; MARGIN-BOTTOM: 5px; BORDER-LEFT: 0px; BORDER-BOTTOM: 0px
}
</STYLE>

<META content="MSHTML 6.00.2900.3492" name=GENERATOR></HEAD>
<BODY>
<H1>ExtMail Solution HOWTO for Linux</H1>
<H3>版权声明：</H3>
<P><B>本文版权归作者所有，如其他个人、第三方网站或媒体报刊等需转载全文或节选，为支持我们的工作，请务必注明如下信息：</B> 
<UL>
  <LI>文档所有者：Extmail Dev Team; 
  <LI>文章原始出处：<A 
  href="http://www.extmail.org/docs/extmail_solution_linux/">http://www.extmail.org/docs/extmail_solution_linux/</A> 

  <LI>项目首页：<A href="http://www.extmail.org/">http://www.extmail.org/</A> 
</LI></UL>如果因此而给您带来麻烦，请您原谅，谢谢合作。
<P></P>
<H3>变更说明</H3>
<UL>
  <LI>0.21 2008-03-23：文档及其涉及软件的全面更新， 作者 Ray 
  <LI>0.20 2006-11-26：增加对uidnumber/gidnumber说明，感谢elm 
  <LI>0.19 2006-11-25：增加对maildrop增加vuser/vgroup说明，感谢elm 
  <LI>0.18 2006-09-04：修正一处输入错误，一处不明确的地方 
  <LI>0.17 2006-08-30：修正缺漏receive_override_options的bug 
  <LI>0.16 2006-08-28：修正maildrop配置错误，感谢风云！ 
  <LI>0.15 2006-08-17：增加mysql/httpd开机自启动的支持 </LI></UL>
<H3>关于此文</H3>
<UL>
  <LI>版　　本：0.21 
  <LI>作　　者：He zhiqiang &lt;hzqbbc (at) extmail (dot) org&gt; , Ray 
  &lt;raykingecs (at) extmail (dot) org&gt; 
  <LI>项目主页：<A href="http://www.extmail.org/">http://www.extmail.org/</A> 
  <LI>个人主页：<A href="http://www.hzqbbc.com/">http://www.hzqbbc.com/</A> 
  <LI>最后更新：2008-3-20 </LI></UL>
<P>本文档以<B><I>2005-07-25</I></B>的早期文档为蓝本，以RPM系统为基础（基于RPM系统具有方便、快捷，易快速复制和重现的优点。如果用户希望获得这些RPM包的源码包，可以与Extmail 
Dev Team联系）。所涉及软件全部是OpenSource软件，版权以GPL为主，作为企业应用没有任何版权/法律问题。</P>
<P>编写本文的初衷，是给那些希望快速架设邮件系统而不想过多了解复杂的系统知识的网管/用户，为了使软件之间的结合更紧密，部分软件的配置及测试方面进行了增强改进，因此本文的一些操作步骤Extmail 
Dev Team不保证在其他场合能完全适用，敬请注意。 </P>
<P>本文档假设读者在CentOS 4.x或 RedHat EnterPrise Linux 4.x平台上安装，并具有一定的Unix平台 / 
Linux平台系统经验，懂得rpm基本命令及常规的系统操作，如文件的删除，目录创建，改名，和vi编辑器的基本使用等。</P>
<P>本文档假设待安装邮局的域名为extmail.org并已在DNS设置MX记录指向mail.extmai.org。读者请根据自身实际情况予以修改。</P>
<P>本文档所有内容均在Centos4.6系统安装、测试通过。</P>
<P>本文档由Extmail项目组负责解释，并根据Extmail项目的建设和发展，适时予以更新。如手册与实际项目情况有冲突，以文档服从实际为原则。</P>
<H3>文档目录</H3>
<UL>
  <LI><A 
  href="http://www.extmail.org/docs/extmail_solution_linux/#intro">ExtMail 
  Solution概述</A> 
  <LI><A 
  href="http://www.extmail.org/docs/extmail_solution_linux/#hardware">硬件配置</A> 
  <LI><A 
  href="http://www.extmail.org/docs/extmail_solution_linux/#os">操作系统安装</A> 
  <LI><A 
  href="http://www.extmail.org/docs/extmail_solution_linux/#basic">下载ExtMail 
  Solution软件包</A> 
  <LI><A 
  href="http://www.extmail.org/docs/extmail_solution_linux/#postfix">MTA-Postfix配置</A> 

  <LI><A 
  href="http://www.extmail.org/docs/extmail_solution_linux/#authlib">配置Courier-Authlib</A> 

  <LI><A 
  href="http://www.extmail.org/docs/extmail_solution_linux/#maildrop">安装maildrop</A> 

  <LI><A 
  href="http://www.extmail.org/docs/extmail_solution_linux/#apache">配置Apache</A> 

  <LI><A 
  href="http://www.extmail.org/docs/extmail_solution_linux/#extmail">安装Webmail-ExtMail</A> 

  <LI><A 
  href="http://www.extmail.org/docs/extmail_solution_linux/#extman">安装管理后台-ExtMan</A> 

  <LI><A 
  href="http://www.extmail.org/docs/extmail_solution_linux/#mailgraph_ext">配置图形化日志系统-mailgraph_ext</A> 

  <LI><A 
  href="http://www.extmail.org/docs/extmail_solution_linux/#test">测试基本系统</A> 
  <LI><A 
  href="http://www.extmail.org/docs/extmail_solution_linux/#sasl">配置Cyrus-SASL</A> 

  <LI><A 
  href="http://www.extmail.org/docs/extmail_solution_linux/#imap">安装Courier-IMAP</A> 

  <LI><A 
  href="http://www.extmail.org/docs/extmail_solution_linux/#filter">内容/病毒过滤</A> 
  <OL><A 
    href="http://www.extmail.org/docs/extmail_solution_linux/#filter_prepare">准备工作</A></OL>
  <OL><A 
    href="http://www.extmail.org/docs/extmail_solution_linux/#filter_clamav">ClamAV</A></OL>
  <OL><A 
    href="http://www.extmail.org/docs/extmail_solution_linux/#filter_amavis">Amavisd-new</A></OL>
  <OL><A 
    href="http://www.extmail.org/docs/extmail_solution_linux/#filter_mta">配置Postfix</A></OL>
  <OL><A 
    href="http://www.extmail.org/docs/extmail_solution_linux/#filter_test">测试</A></OL>
  <LI><A 
  href="http://www.extmail.org/docs/extmail_solution_linux/#slockd">反垃圾邮件-Spam 
  Locker</A> 
  <OL><A 
    href="http://www.extmail.org/docs/extmail_solution_linux/#slockd_prepare">准备工作</A></OL>
  <OL><A 
    href="http://www.extmail.org/docs/extmail_solution_linux/#slockd_test">配置/测试</A></OL>
  <OL><A 
    href="http://www.extmail.org/docs/extmail_solution_linux/#slockd_mta">与Postfix结合</A></OL>
  <LI><A 
  href="http://www.extmail.org/docs/extmail_solution_linux/#last_test">最终测试</A> 
  <LI><A 
  href="http://www.extmail.org/docs/extmail_solution_linux/#extra">附加信息</A> 
  <OL><A 
    href="http://www.extmail.org/docs/extmail_solution_linux/#extra_fcgi">增加FCGI支持</A></OL>
  <OL><A 
    href="http://www.extmail.org/docs/extmail_solution_linux/#extra_courier-imap">编译Courier-IMAP</A></OL>
  <LI><A href="http://www.extmail.org/docs/extmail_solution_linux/#end">结束语</A> 
  <LI><A 
  href="http://www.extmail.org/docs/extmail_solution_linux/#bugs">已知Bugs</A> 
  <LI><A 
  href="http://www.extmail.org/docs/extmail_solution_linux/#todo">TODO列表</A> 
  </LI></UL>
<H3><A name=intro></A>ExtMail Solution 结构</H3>
<P>ExtMail Solution 是一个基于优秀开源软件的电子邮件系统解决方案，核心部件包括了Postfix, Amavisd-new, ClamAV, 
ExtMail 和ExtMan， Courier系列软件。是一个功能相对比较齐全的免费电子邮件系统。以下是其主要的特性列表： 
<UL>
  <LI>支持SMTP/POP3/HTTP协议 
  <LI>支持SMTP认证及ESMTP 
  <LI>可支持大容量邮箱(大于1GB） 
  <LI>高速Web界面访问邮箱 
  <LI>完整的Web管理后台 
  <LI>在线服务端病毒过滤 
  <LI>内建内容过滤 
  <LI>SMTP行为识别垃圾邮件 
  <LI>支持大量反垃圾邮件技术 
  <LI>图形化邮件日志分析 
  <LI>支持别名/多域/域管理员等 
  <LI>支持网络磁盘/POP3邮件 
  <LI>支持读/写HTML格式邮件 
  <LI>支持定制模板及多语言 </LI></UL><BR>
<P>整个邮件解决方案由如下软件组成：<BR>&nbsp;</P>
<TABLE width="100%" border=1>
  <TBODY>
  <TR>
    <TD><SPAN>功能模块</SPAN></TD>
    <TD><SPAN>内容</SPAN></TD>
    <TD>备注</TD></TR>
  <TR>
    <TD><SPAN>操作系统（</SPAN>OS<SPAN>）</SPAN></TD>
    <TD>CentOS 4.6</TD>
    <TD>CentOS<SPAN>和</SPAN>RHEL<SPAN>是一样的，而且升级免费</SPAN></TD></TR>
  <TR>
    <TD><SPAN>邮件传输代理（</SPAN>MTA<SPAN>）</SPAN></TD>
    <TD>Postfix 2.5.1</TD>
    <TD><SPAN>使用最新版本2.5.1</SPAN></TD></TR>
  <TR>
    <TD><SPAN>数据库/目录服务</SPAN></TD>
    <TD>MySQL 4.1</TD>
    <TD><SPAN>可选</SPAN>openLDAP<SPAN>或</SPAN>NetScape 
      LDAP<SPAN>，本文以</SPAN>MySQL<SPAN>为蓝本</SPAN></TD></TR>
  <TR>
    <TD><SPAN>邮件投递代理（</SPAN>MDA<SPAN>）</SPAN></TD>
    <TD>maildrop 2.0.x</TD>
    <TD><SPAN>支持过滤和强大功能</SPAN></TD></TR>
  <TR>
    <TD>Web<SPAN>帐户管理后台</SPAN></TD>
    <TD>ExtMan 0.2.4</TD>
    <TD><SPAN>支持无限域名、无限用户</SPAN></TD></TR>
  <TR>
    <TD>POP3 <SPAN>服务器</SPAN></TD>
    <TD>Courier-IMAP</TD>
    <TD><SPAN>只使用pop3部分，对于大部分企业而言完全足够</SPAN></TD></TR>
  <TR>
    <TD>WebMail <SPAN>系统</SPAN></TD>
    <TD>ExtMail 1.0.4</TD>
    <TD><SPAN>支持多语言、全部模板化，功能基本齐全</SPAN></TD></TR>
  <TR>
    <TD><SPAN>防病毒软件（</SPAN>Anti-Virus<SPAN>）</SPAN></TD>
    <TD>ClamAV 0.92-2</TD>
    <TD><SPAN>最热门的开源杀毒软件</SPAN></TD></TR>
  <TR>
    <TD>SMTP<SPAN>阶段反垃圾邮件工具</SPAN></TD>
    <TD>Spam Locker 0.10</TD>
    <TD>基于SMTP<SPAN>行为识别的</SPAN>Antispam<SPAN>软件，大量可选插件</SPAN></TD></TR>
  <TR>
    <TD><SPAN>内容过滤器</SPAN></TD>
    <TD>Amavisd-new 2.5.4</TD>
    <TD>Content-Filte<SPAN>r软件</SPAN>，支持与clamav/sa的挂接</TD></TR>
  <TR>
    <TD><SPAN>内容级别的反垃圾邮件工具</SPAN></TD>
    <TD>SpamAssassin</TD>
    <TD><SPAN>著名的</SPAN>SA<SPAN>，可以支持大量规则，但速度慢</SPAN></TD></TR>
  <TR>
    <TD>SMTP<SPAN>认证库</SPAN></TD>
    <TD>Cyrus SASL 2.1x</TD>
    <TD><SPAN>标准的</SPAN>SASL<SPAN>实现库，可以支持</SPAN>Courier authlib</TD></TR>
  <TR>
    <TD><SPAN>其他数据认证库</SPAN></TD>
    <TD>Courier Authlib 0.60</TD>
    <TD>authlib<SPAN>是</SPAN>maildrop, courier-imap<SPAN>等服务的关键部件</SPAN></TD></TR>
  <TR>
    <TD><SPAN>日志分析及显示</SPAN></TD>
    <TD>mailgraph_ext</TD>
    <TD><SPAN>在</SPAN>ExtMan<SPAN>中已经包含了</SPAN></TD></TR>
  <TR>
    <TD><SPAN>Web 服务器</SPAN></TD>
    <TD>Apache 2.0.x</TD>
    <TD>CentOS 自带</TD></TR></TBODY></TABLE><BR>
<H3><A name=hardware></A>硬件配置</H3>
<P>要流畅地运行邮件系统，建议的硬件配置如下：</P>
<UL>
  <LI>物理内存：512M+ 推荐1024M; 
  <LI>交换区：2倍物理内存大小; 
  <LI>CPU：PIII 1G+ 推荐P4及其以上级别; 
  <LI>主板：推荐Intel原装; 
  <LI>网卡：100M/1000M 推荐3Com/Intel; </LI></UL>
<H3><A name=os></A>操作系统安装</H3>
<P>本文档支持RedHat Enterprise 4.x 及CentOS 4.x版本。要注意的是安装系统时，只安装如下的组件： 
<UL>
  <LI>
  <DIV class=sm_title>Web Server</DIV>要注意必须选中httpd-suexec软件包，否则下文的配置将失效 
  <LI>
  <DIV class=sm_title>MYSQL数据库</DIV>注意必须选中mysql-server, libdbi-dbd-mysql, 
  perl-DBD-mysql等模块，否则extmail将无法连接mysql 
  <LI>
  <DIV 
  class=sm_title>VIM编辑器</DIV>强烈建议安装vim-enhanced软件包，它支持main.cf<B>彩色高亮语法分析</B> 
  </LI></UL>
<P>其余的Xwindows, 打印，KDE/Gnore, 
服务器配置工具，网络工具，开发包等全部都不是必选组件。安装完毕进入操作系统后，为增加系统安全性，建议禁止root直接登陆，并增加一个非root帐户，例如sysadmin。这样无法以root账户直接登陆系统，必须先以sysadmin身份登陆再su到root执行。方法：</P>
<H4>CentOS4.6安装步骤图解</H4>
<P>以下将以详细的图解来介绍如何安装CentOS4.3</P>
<P><IMG 
src="CentOS 4_6 ExtMail Solution Howto.files/vm1.gif"><BR>CentOS启动光盘的启动画面，直接回车即可。 
</P>
<P><IMG 
src="CentOS 4_6 ExtMail Solution Howto.files/vm2.gif"><BR>系统提示“是否需要校验CD媒质”，请选择“Skip”。 
</P>
<P><IMG 
src="CentOS 4_6 ExtMail Solution Howto.files/vm3.gif"><BR>选择“English”作为安装界面的语言。 
</P>
<P><IMG 
src="CentOS 4_6 ExtMail Solution Howto.files/vm4.gif"><BR>安装类型请务必选择“Custom”，以便之后详细选择要装的软件包。 
</P>
<P><IMG 
src="CentOS 4_6 ExtMail Solution Howto.files/vm5.gif"><BR>磁盘分区设置请选择“Manually 
partition with disk Druid”（手工分区）。 </P>
<P><IMG 
src="CentOS 4_6 ExtMail Solution Howto.files/vm6.gif"><BR>如图，我们将/，/usr，/var，/var/spool/postfix等单独分成一个分区，注意：如果磁盘大小允许，请将/var/spool/vscan目录也单独成一个分区，该目录主要存放被过滤的临时邮件。 
</P>
<P><IMG 
src="CentOS 4_6 ExtMail Solution Howto.files/vm7.gif"><BR>设置服务器IP地址及子网掩码，记得点选“Activate 
boot”。 </P>
<P><IMG 
src="CentOS 4_6 ExtMail Solution Howto.files/vm8.gif"><BR>设置服务器网关及DNS，请将离你的服务器最近DNS服务器IP地址填入“Primary 
DNS”。 </P>
<P><IMG 
src="CentOS 4_6 ExtMail Solution Howto.files/vm9.gif"><BR>防火墙配置时，打开防火墙（选Enable 
FireWall），并放行常规的服务（服务列表全选），最重要的是记得打开SELinux（选Active） </P>
<P><IMG src="CentOS 4_6 ExtMail Solution Howto.files/vm10.gif"><BR>时区选“上海”。 </P>
<P><IMG 
src="CentOS 4_6 ExtMail Solution Howto.files/vm11.gif"><BR>输入root帐户密码，建议使用较长的密码，并混杂数字与字母及特殊字符。 
</P>
<P><IMG 
src="CentOS 4_6 ExtMail Solution Howto.files/vm12.gif"><BR>进入软件组的选择对话界面后，我们只选择Editors组。 
</P>
<P><IMG src="CentOS 4_6 ExtMail Solution Howto.files/vm13.gif"><BR>其次选择是Web 
Server及FTP Server组。 </P>
<P><IMG src="CentOS 4_6 ExtMail Solution Howto.files/vm14.gif"><BR>再次选择MySQL 
DataBase组，并点击右边的Details </P>
<P><IMG 
src="CentOS 4_6 ExtMail Solution Howto.files/vm15.gif"><BR>在Details对话框里，确保libdbi-dbd-mysql，mysql-server，perl-DBD-MySQL等模块都被选中。extmail依赖这些软件包。 
</P>
<P><IMG 
src="CentOS 4_6 ExtMail Solution Howto.files/vm16.gif"><BR>最后，确认一下所做的选择。其他没有被提到的软件模块/组全部都去掉。总共软件大小有900MB左右。 
</P>
<P><IMG 
src="CentOS 4_6 ExtMail Solution Howto.files/vm17.gif"><BR>点Next后，安装系统提示必须要准备好CentOS的第1，2，3张光盘。 
</P>
<P><IMG 
src="CentOS 4_6 ExtMail Solution Howto.files/vm18.gif"><BR>系统进行初始化，磁盘分区等。 </P>
<P><IMG 
src="CentOS 4_6 ExtMail Solution Howto.files/vm19.gif"><BR>系统安装到后面时，需要换安装盘。请将盘2及盘3按提示放入光驱。 
</P>
<P><IMG 
src="CentOS 4_6 ExtMail Solution Howto.files/vm20.gif"><BR>安装完毕后，出现祝贺完成的界面，点Reboot重新启动。 
</P>
<P><IMG 
src="CentOS 4_6 ExtMail Solution Howto.files/vm21.gif"><BR>如无意外，系统进入登陆提示符界面。至此，CentOS4.6的安装就结束了。 
</P>
<P>以root身份登进系统后，增加一个非root帐户，名称为sysadmin，密码按您的需求设置一个即可。接下来我们要禁止root直接登陆，编辑/etc/ssh/sshd_config 
修改以下配置为： 
<DIV class=line>PermitRootLogin no </DIV><BR>
<P>然后重新启动sshd：</P>
<DIV class=line>/etc/init.d/sshd restart</DIV>
<P>这样禁止了root直接登陆。</P>
<P></P>
<DIV class=sm_title>配置SELinux</DIV><BR>
<P>自从RHEL4/CentOS4以后，系统默认打开了SELinux支持，简单说SELinux就是一个强制性的安全机制，但是它也带来了不少麻烦，为了避免编写烦琐的policy规则，本文档将屏蔽掉SELinux对MySQL及httpd的保护。方法如下：</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">setsebool httpd_disable_trans=1
setsebool mysqld_disable_trans=1
</PRE>
<P>操作完毕后，重新启动mysql及apache，并将如下命令加入/etc/rc.d/rc.local以便服务器启动后能自动生效：</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">/usr/sbin/setsebool httpd_disable_trans=1
/usr/sbin/setsebool mysqld_disable_trans=1
/etc/init.d/mysqld restart
/etc/init.d/httpd restart
</PRE>
<H3><A name=basic></A>下载ExtMail Solution软件包</H3>
<H4>基本假定</H4>
<P>整个系统的安装全过程都要求以root身份执行，如果机器没有访问外部网络的能力，则事先下载好ExtMail 
Solution软件包，并用ftp以sysadmin帐户的身份，上载到服务器。</P>
<H4>下载软件包</H4>我们统一将软件包下载到/root目录里。 <PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">su - root
cd /root
wget <A href="http://www.extmail.org/source/ExtMail-Solution-Linux-0.2.tar.gz">http://www.extmail.org/source/ExtMail-Solution-Linux-0.2.tar.gz</A>
</PRE>
<H4>校验</H4>
<P>下载的文件必须校验确认过没损坏才能使用。命令如下：</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">wget <A href="http://www.extmail.org/source/md5sum.es_linux-0.2">http://www.extmail.org/source/md5sum.es_linux-0.2</A>
cat md5sum.es_linux-0.2
md5sum ExtMail-Solution-Linux-0.2.tar.gz 
</PRE>
<P>一个可能的结果：</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid"># cat md5sum.es_linux-0.2
168eced41c0cac0ed9f981e791f3783b ExtMail-Solution-Linux-0.2.tar.gz
# md5sum ExtMail-Solution-Linux-0.2.tar.gz
168eced41c0cac0ed9f981e791f3783b ExtMail-Solution-Linux-0.2.tar.gz
</PRE>
<P>由于软件包不断的变更，所以上述结果和您的结果可能不一致，请以下载的md5sum为准</P>
<H4>解压</H4>
<P>目前最新的ExtMail-Solution软件包版本号为0.2，软件包文件名为：ExtMail-Solution-Linux-0.2.tar.gz，下载回来后，在/root目录解开：</P>
<DIV class=line>tar xfz ExtMail-Solution-Linux-0.2.tar.gz </DIV>
<P>此外，我们假设本次安装默认域是extmail.org，主机名为：mail.extmail.org，ExtMail 
Solution的文件目录是/root/ExtMail-Solution-Linux-0.2/</P>
<DIV class=sm_title>重要步骤：</DIV>
<P>我们进入/root/ExtMail-Solution-Linux-0.2/目录，该目录下包括如下文件/目录： <PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">conf/
docs/
RPMS/
src/
README
</PRE>
<P>其中RPMS目录是本文的重点，里面包含了所需要的全部rpm包，src目录则是存放webmail, 
anti-spam等相关软件的源码，而README则是说明文件，docs目录则是本文档相关的html及图片。</P>
<P>下文所涉及的操作，绝大部分都是发生在/root/ExtMail-Solution-Linux-0.2目录里，请确保当前目录为：<B><I>/root/ExtMail-Solution-Linux-0.2</I></B></P>
<H3><A name=postfix></A>配置Postfix MTA</H3>删除冲突软件,sendmail，需要执行: 
<DIV class=line>rpm -e --nodeps sendmail</DIV><BR>
<DIV class=sm_title>mysql有关软件：</DIV>
<P>CentOS4.x/ RedHat EL4.x 都自带mysql-server，请用户自行安装好，包括mysql-client和devel等包</P>
<DIV class=sm_title>安装postfix</DIV>
<DIV class=line>rpm -ivh --nodeps RPMS/postfix-2.5.1-2ext.i386.rpm </DIV><BR>
<DIV class=sm_title>配置postfix</DIV>简化postfix配置: <PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">postconf -n &gt; /etc/postfix/main2.cf
mv /etc/postfix/main.cf /etc/postfix/main.cf.old
mv /etc/postfix/main2.cf /etc/postfix/main.cf
</PRE>
<P>再编辑main.cf：</P>
<DIV class=line>vi /etc/postfix/main.cf</DIV><BR>增加如下内容： <PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid"># hostname
mynetworks = 127.0.0.1
myhostname = mail.extmail.org
mydestination = $mynetworks $myhostname

# banner
mail_name = Postfix - by extmail.org
smtpd_banner = $myhostname ESMTP $mail_name

# response immediately
smtpd_error_sleep_time = 0s
unknown_local_recipient_reject_code = 450

# extmail config here
virtual_alias_maps = mysql:/etc/postfix/mysql_virtual_alias_maps.cf
virtual_mailbox_domains = mysql:/etc/postfix/mysql_virtual_domains_maps.cf
virtual_mailbox_maps = mysql:/etc/postfix/mysql_virtual_mailbox_maps.cf
virtual_transport = maildrop:
</PRE>
<DIV class=sm_title>编辑mysql_virtual_alias_maps.cf</DIV>
<DIV class=line>vi /etc/postfix/mysql_virtual_alias_maps.cf</DIV><BR>内容如下： <PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">user = extmail
password = extmail
hosts = localhost
dbname = extmail
table = alias
select_field = goto
where_field = address
</PRE>
<DIV class=sm_title>编辑mysql_virtual_domains_maps.cf</DIV>
<DIV class=line>vi /etc/postfix/mysql_virtual_domains_maps.cf</DIV><BR>内容如下： <PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">user = extmail
password = extmail
hosts = localhost
dbname = extmail
table = domain
select_field = description
where_field = domain
#additional_conditions = and backupmx ='0' and active ='1'
</PRE>
<DIV class=sm_title>编辑mysql_virtual_mailbox_maps.cf</DIV>
<DIV class=line>vi /etc/postfix/mysql_virtual_mailbox_maps.cf</DIV>内容如下： <PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">user = extmail
password = extmail
hosts = localhost
dbname = extmail
table = mailbox
select_field = maildir
where_field = username
#additional_conditions = and active = '1'
</PRE>
<H3><A name=authlib></A>配置Courier-Authlib</H3>
<H4>安装Courier-Authlib</H4>
<P>运行如下命令安装相关软件包</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">rpm -ivh RPMS/libtool-libs-1.5.6-4.EL4.2.i386.rpm
rpm -ivh RPMS/courier-authlib-0.60.2-1ext.i386.rpm
rpm -ivh RPMS/courier-authlib-devel-0.60.2-1ext.i386.rpm
rpm -ivh RPMS/courier-authlib-mysql-0.60.2-1ext.i386.rpm
</PRE>
<P>编辑/etc/authlib/authmysqlrc文件，并将其内容清空，然后增加如下内容：</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">MYSQL_SERVER            localhost
MYSQL_USERNAME          extmail
MYSQL_PASSWORD          extmail
MYSQL_SOCKET            /var/lib/mysql/mysql.sock
MYSQL_PORT              3306
MYSQL_OPT               0
MYSQL_DATABASE          extmail
MYSQL_USER_TABLE        mailbox
MYSQL_CRYPT_PWFIELD     password
MYSQL_UID_FIELD         uidnumber
MYSQL_GID_FIELD         gidnumber
MYSQL_LOGIN_FIELD       username
MYSQL_HOME_FIELD        homedir
MYSQL_NAME_FIELD        name
MYSQL_MAILDIR_FIELD     maildir
MYSQL_QUOTA_FIELD       quota
MYSQL_SELECT_CLAUSE     SELECT username,password,"",uidnumber,gidnumber,\
                        CONCAT('/home/domains/',homedir),               \
                        CONCAT('/home/domains/',maildir),               \
                        quota,                                          \
                        name                                            \
                        FROM mailbox                                    \
                        WHERE username = '$(local_part)@$(domain)'
</PRE>
<P>存盘退出后启动courier-authlib：</P>
<DIV class=line>service courier-authlib start </DIV>
<P>如一切正常，命令行将返回如下信息：</P>
<DIV class=line>Starting Courier authentication services: authdaemond </DIV><BR>
<DIV class=sm_title>修改authdaemon 
socket目录权限</DIV><BR>如果该目录权限不正确修改，maildrop及postfix等将无法正确获取用户的信息及密码认证： 
<DIV class=line>chmod 755 /var/spool/authdaemon/ </DIV><BR>
<H3><A name=maildrop></A>安装Maildrop</H3>
<DIV class=sm_title>安装maildrop</DIV><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">rpm -ivh RPMS/maildrop-2.0.4-1ext.i386.rpm
rpm -ivh RPMS/maildrop-man-2.0.4-1ext.i386.rpm
</PRE><BR>
<DIV 
class=sm_title>配置master.cf</DIV>为了使Postfix支持Maildrop，必须修改/etc/postfix/master.cf文件，注释掉原来的maildrop的配置内容，并改为： 
<PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">maildrop   unix        -       n        n        -        -        pipe
    flags=DRhu user=vuser argv=maildrop -w 90 -d ${user}@${nexthop} ${recipient} ${user} ${extension} {nexthop}
</PRE>
<DIV class=sm_title>配置main.cf</DIV>
<P>由于maildrop不支持一次接收多个收件人，因此必须在main.cf里增加如下参数：</P>
<DIV class=line>maildrop_destination_recipient_limit = 1</DIV>
<P>最后重新启动postfix即可</P><BR>
<DIV class=sm_title>注意事项：</DIV>
<P><B>1.</B>如需重新编译Maildrop软件包，必须先获得其源码rpm包，并且必须先行安装courier-authlib及其devel软件包，否则编译后的maildrop将无法打开authlib支持。</P>
<P><B>2.</B>maildrop 
RPM包安装时，会自动创建vuser用户及vgroup用户组，专门用于邮件的存储，vuser:vgroup的uid/gid都是1000，这与一般的邮件文档中提及用postfix用户存邮件不一样。因为postfix用户的uid一般都低于500，而Suexec模块编译时对UID/GID的要求是要大于500，因此使用postfix用户不能满足要求。其次，如果用Maildrop作为投递代理（MDA），以postfix身份投递的话，会导致postfix 
MTA错误。</P>
<H3><A name=apache></A>配置Apache</H3>编辑httpd.conf： 
<DIV class=line>vi 
/etc/httpd/conf/httpd.conf</DIV><BR>在730行左右，屏蔽掉AddDefaultCharset： 
<DIV class=line>#AddDefaultCharset UTF-8 </DIV><BR>使apache开机默认启动：<BR>
<DIV class=line>chkconfig httpd on </DIV><BR>
<H4>虚拟主机设置</H4>编辑/etc/httpd/conf/httpd.conf文件，在最后一行加上：<BR><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">NameVirtualHost *:80
Include conf/vhost_*.conf
</PRE><BR>编辑/etc/httpd/conf/vhost_extmail.conf，里面定义虚拟主机的相关内容，包括主目录，以及ExtMail和ExtMan的相关配置，Suexec的设置等。 
<PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid"># VirtualHost for ExtMail Solution
&lt;VirtualHost *:80&gt;
ServerName mail.extmail.org
DocumentRoot /var/www/extsuite/extmail/html/

ScriptAlias /extmail/cgi/ /var/www/extsuite/extmail/cgi/
Alias /extmail/ /var/www/extsuite/extmail/html/

ScriptAlias /extman/cgi/ /var/www/extsuite/extman/cgi/
Alias /extman/ /var/www/extsuite/extman/html/

# Suexec config
SuexecUserGroup vuser vgroup
&lt;/VirtualHost&gt;
</PRE>重新启动apache: 
<DIV class=line>service httpd restart</DIV>
<P><B>注意：</B>此时重新启动apache会产生以下警告信息，可不必理会</P>
<DIV class=line>Starting httpd: Warning: DocumentRoot 
[/var/www/extsuite/extmail/html/] does not exist </DIV><BR>
<H3><A name=extmail></A>安装ExtMail</H3>建立/var/www/extsuite并复制源码到该目录，相关命令： <PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">mkdir /var/www/extsuite
tar -zxvf src/extmail-1[1][1].0.4.tar.gz -C src
cp -r src/extmail-1.0.4 /var/www/extsuite/extmail
cd /var/www/extsuite/extmail
cp webmail.cf.default webmail.cf
cd $OLDPWD
</PRE>
<P><B>注意：</B>上面命令行中最后一个cd $OLDPWD是返回原始路径（即ExtMail 
Solution软件包根目录）</P>安装perl-Unix-Syslog包 <PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">rpm -ivh RPMS/perl-Unix-Syslog-1.0-1ext.i386.rpm
</PRE>
<DIV 
class=sm_title>编辑webmail.cf</DIV>修改/var/www/extsuite/extmail/webmail.cf里的其他参数，主要变动的内容见下： 
<BR><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">SYS_USER_LANG = zh_CN
SYS_USER_CHARSET = gb2312

SYS_MFILTER_ON = 1
SYS_NETDISK_ON = 1
SYS_SHOW_SIGNUP = 1

SYS_MYSQL_USER = extmail
SYS_MYSQL_PASS = extmail
SYS_MYSQL_DB = extmail

SYS_G_ABOOK_TYPE = file
SYS_G_ABOOK_FILE_CHARSET = gb2312

</PRE>
<P>其中SYS_MFILTER_ON及SYS_NETDISK_ON 
设置为1是为了打开网络磁盘和过滤器；SYS_SHOW_SIGNUP控制首页是否显示免费注册邮箱按钮；全局地址本默认为ldap格式，现在也改为文本格式，并将地址本的转换编码改为GB2312 
</P>
<DIV class=sm_title>更新cgi目录权限</DIV>
<P>由于SuEXEC的需要，必须将extmail的cgi目录修改成vuser:vgroup权限：</P>
<DIV class=line>chown -R vuser:vgroup /var/www/extsuite/extmail/cgi/ </DIV>
<H3><A name=extman></A>安装ExtMan - web后台</H3>
<P>在ExtMail-Solution软件包根目录下执行：</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">tar -zxvf src/extman-0[1][1].2.4.tar.gz -C src
cp -r src/extman-0.2.4 /var/www/extsuite/extman/
</PRE><BR>
<DIV 
class=sm_title>配置webman.cf</DIV>修改/var/www/extsuite/extman/webman.cf内SYS_CHARSET及SYS_LANG参数为： 
<BR><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">SYS_CAPTCHA_ON = 1
# SYS_CAPTCHA_ON参数控制首页是否采用校验码登陆
SYS_CHARSET = gb2312
SYS_LANG = zh_CN
</PRE>
<P>其他参数基本上可以使用默认值。 </P>安装perl-GD包 <PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">rpm -ivh RPMS/perl-GD-2.35-2ext.i386.rpm
</PRE>
<DIV class=sm_title>更新cgi目录权限</DIV>
<P>由于SuEXEC的需要，必须将extman的cgi目录修改成vuser:vgroup权限：</P>
<DIV class=line>chown -R vuser:vgroup /var/www/extsuite/extman/cgi/ </DIV><BR>
<DIV class=sm_title>确认MySQL状态</DIV>
<P>在执行mysql操作前，必须确认它已被正确安装并启动，可以用rpm命令查询mysql server的安装情况，用ps 
ax的办法查看进程列表是否有mysqld进程：</P>
<DIV class=line>rpm -aq|grep -i mysql-server </DIV>
<P>正常情况下应该可以看到mysql-server被安装：</P>
<DIV class=line>mysql-server-4.1.20-2.RHEL4.1.0.1 </DIV>
<P>如果没有，则表示没有安装好mysql-server，可以从本软件包RPMS目录里安装，也可以找安装光盘安装：</P>
<DIV class=line>rpm -ivh RPMS/mysql-server-4.1.20-2.RHEL4.1.0.1.i386.rpm </DIV>
<P>安装完毕后必须初始化mysql，然后重新启动</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">/usr/bin/mysql_install_db
service mysqld start
</PRE>
<P>正常情况下将启动成功：</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">Starting MySQL:                                            [  <FONT color=green>OK</FONT>  ]
</PRE>
<P>然后用ps命令来检查mysqld是否正确运行：</P>
<DIV class=line>ps ax|grep mysqld </DIV>
<P>正常情况下应出现如下的结果：</P>
<DIV class=line>433 pts/0 S 0:00 /bin/sh /usr/bin/mysqld_safe 
--defaults-file=/etc/my.cnf --pid-file=/var/run/mysqld/mysqld.pid<BR>466 pts/0 
Sl 0:00 /usr/libexec/mysqld --defaults-file=/etc/my.cnf --basedir=/usr 
--datadir=/var/lib/mysql --user=mysql --pid-file=/var/run/mysqld/mysqld.pid 
--skip-locking --socket=/var/lib/mysql/mysql.sock </DIV>
<P>如果mysql没正确启动，请检查/var/log/mysqld.log里面的出错提示，进行处理：</P>
<DIV class=line>tail /var/log/mysqld.log </DIV><BR>
<DIV class=sm_title>数据库初始化</DIV>
<P>执行以下命令导入mysql数据库结构及初始化数据，<B>注意必须逐行输入以下命令，root密码默认为空</B>，不可直接用鼠标复制两行命令直接输入，否则会报错！</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">mysql -u root -p &lt; /var/www/extsuite/extman/docs/extmail.sql
mysql -u root -p &lt; /var/www/extsuite/extman/docs/init.sql
</PRE>
<DIV class=sm_title>链接基本库到Extmail</DIV><BR>建立临时文件夹： <PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">mkdir /tmp/extman
chown -R vuser:vgroup /tmp/extman
</PRE>
<P>建立刚才导入mysql的postmaster@extmail.org帐户的Maildir，请输入如下命令：</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">cd /var/www/extsuite/extman/tools
./maildirmake.pl /home/domains/extmail.org/postmaster/Maildir
chown -R vuser:vgroup /home/domains/extmail.org
cd $OLDPWD
</PRE>
<P><B>注意事项：</B><BR>
<P>上面命令行中最后一个cd $OLDPWD是返回原始路径（即ExtMail Solution软件包根目录）</P>
<P>由于RedHat发行版中包含了一个叫tmpwatch的工具，该工具会定期扫描/tmp/下的文件，如果这些文件很久都没被使用，将被删除，因此如果后台长期不使用，/tmp/extman目录有可能被tmpwatch删除，所以要么定期登陆后台，要么修改 
webman.cf将临时目录修改到另一个地方。此处暂以/tmp/extman默认值为例。 </P>
<P>上述导入初始化SQL时，默认的uidnumber/gidnumber都是1000，这和vuser:vgroup 
的uid/gid一致，是因为maildrop投递时会从数据库里取uidnumber/gidnumber，而在master.cf里已经定义好了投递时的运行身份（vuser:vgroup），所以这两个字段的内容必须为1000，否则将出现投递错误，例如报0x06等错误。</P>
<P></P>
<DIV class=sm_title>测试authlib</DIV>
<P>在命令行下执行：</P>
<DIV class=line>/usr/sbin/authtest -s login postmaster@extmail.org extmail 
</DIV>
<P>结果如下：</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">Authentication succeeded.

     Authenticated: postmaster@extmail.org  (uid 1000, gid 1000)
    Home Directory: /home/domains/extmail.org/postmaster
           Maildir: /home/domains/extmail.org/postmaster/Maildir/
             Quota: 104857600S
Encrypted Password: $1$phz1mRrj$3ok6BjeaoJYWDBsEPZb5C0
Cleartext Password: extmail
           Options: (none)
</PRE>
<P>这样表明ExtMan的正确安装，数据库也正确导入，courier-authlib能正确连接到mysql数据库</P>
<P>最后访问<A 
href="http://mail.extmail.org/extmail/">http://mail.extmail.org/extmail/</A>，如无意外，将看到webmail的登陆页，不过此时还没有加正式的用户，所以不能登陆，包括postmaster@extmail.org也不行。必须要登陆到<A 
href="http://mail.extmail.org/extman/">http://mail.extmail.org/extman/</A> 
里增加一个新帐户才能登陆。</P>
<P>ExtMan的默认超级管理员帐户：root@extmail.org，初始密码：extmail*123*，登陆成功后，建议将密码修改，以确保安全。</P>
<H3><A name=mailgraph_ext></A>配置Mailgraph_ext</H3>
<P>自ExtMan 0.14-pre2 
开始，系统集成了Mailgraph_ext插件，该插件使extman具备图形化显示邮件日志的能力。mailgraph_ext融合了mailgraph和queuegraph两个软件包，除增加了更多的日志分析及图形显示能力外，还重写了web模块，集成到ExtMan后台里，这样邮件日志将只能给经过授权的用户查看，提高了安全性。</P>
<P>mailgraph_ext及Extman都需要安装rrdtool工具</P>
<DIV class=sm_title>必需的软件包</DIV><BR><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">- Perl 5.6+ (建议5.8以上)
- rrdtool 及rrdtool的perl包，地址：
  <A href="http://people.ee.ethz.ch/~oetiker/webtools/rrdtool/">http://people.ee.ethz.ch/~oetiker/webtools/rrdtool/</A>
- File::Tail (还需要Time::HiRes模块)
</PRE>
<P>RHEL/CentOS一般自带了perl-Time-HiRes(1.5x)所以以下的rpm安装也许会报错（提示冲突），可以不必理会。如果想安装本文所带的新版Time-HiRes模块，可以用如下命令删除系统自带的包：</P>
<DIV class=line>rpm -e perl-Time-HiRes --nodeps </DIV><BR>
<DIV class=sm_title>安装依赖包/RRDtool</DIV><BR><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">rpm -ivh RPMS/rrdtool-1.2.12-2ext.i386.rpm RPMS/perl-rrdtool-1.2.12-2ext.i386.rpm
rpm -ivh RPMS/perl-Time-HiRes-1.72-2ext.i386.rpm
rpm -ivh RPMS/perl-File-Tail-0.99.3-2ext.i386.rpm
</PRE>
<DIV class=sm_title>复制mailgraph_ext</DIV>
<P>执行以下命令：</P>
<DIV class=line>cp -r /var/www/extsuite/extman/addon/mailgraph_ext/ 
/usr/local/mailgraph_ext/ </DIV><BR><B>注意事项：</B><BR>
<P>本文使用qmonitor来搜集队列数据，而不是使用crontab来定时提取，这与官方网站上的文档有差异。使用qmonitor的好处是它实时的监视队列目录的变化，显示的结果更加精确。</P>
<DIV class=sm_title>启动进程</DIV><P->启动mailgraph_ext及qmonitor：
<P></P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">/usr/local/mailgraph_ext/mailgraph-init start
/usr/local/mailgraph_ext/qmonitor-init start
</PRE><BR>
<DIV class=sm_title>加入自启动</DIV><BR>为了一开机就能自动执行上述进程，将上述命令加到rc.local 里面： <PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">echo "/usr/local/mailgraph_ext/mailgraph-init start" &gt;&gt; /etc/rc.d/rc.local
echo "/usr/local/mailgraph_ext/qmonitor-init start" &gt;&gt; /etc/rc.d/rc.local
</PRE>
<H4>使用方法</H4>等待大约15分钟左右，如果邮件系统有一定的流量，即可登陆到extman里，点“图形日志”即可看到图形化的日志。具体每天，周，月，年的则点击相应的图片进入即可。 

<H3><A name=sasl></A>配置Cyrus-SASL 认证</H3>
<P>RHEL4/CentOS4的cyrus-sasl默认没有打开authdaemon的支持，为了使用集中认证的authlib，必须打开这个支持。为此我们必须删除系统的cyrus-sasl软件包，替换成打开了authdaemon支持的sasl软件包。首先要删除系统老的cyrus-sasl：</P>
<DIV class=line>rpm -e --nodeps cyrus-sasl </DIV>
<P>然后安装新的支持authdaemon的软件包</P>
<DIV class=line>rpm -ivh RPMS/cyrus-sasl-2.1.19-5.EL4.i386.rpm </DIV>
<P>Postfix的SMTP认证需要透过Cyrus-SASL，连接到authdaemon获取认证信息，编辑/etc/postfix/main.cf，增加如下内容：</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid"># smtpd related config
smtpd_recipient_restrictions =
    permit_mynetworks,
	permit_sasl_authenticated,
	reject_non_fqdn_hostname,
	reject_non_fqdn_sender,
	reject_non_fqdn_recipient,
	reject_unauth_destination,
	reject_unauth_pipelining,
	reject_invalid_hostname,

# SMTP AUTH config here
broken_sasl_auth_clients = yes
smtpd_sasl_auth_enable = yes
smtpd_sasl_local_domain = $myhostname
smtpd_sasl_security_options = noanonymous
</PRE>
<P>其次用vi编辑/usr/lib/sasl2/smtpd.conf，确保其内容为：</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">pwcheck_method: authdaemond
log_level: 3
mech_list: PLAIN LOGIN
authdaemond_path:/var/spool/authdaemon/socket
</PRE>
<P>存盘退出后，重新启动postfix：</P>
<DIV class=line>service postfix start </DIV><BR>
<DIV class=sm_title>测试SMTP认证</DIV>
<P>通过以下命令获得postmaster@extmail.org的用户名及密码的BASE64编码：</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">perl -e 'use MIME::Base64; print encode_base64("postmaster\@extmail.org")'
cG9zdG1hc3RlckBleHRtYWlsLm9yZw==
perl -e 'use MIME::Base64; print encode_base64("extmail")'
ZXh0bWFpbA==
</PRE>
<P>然后本机测试，其过程如下（蓝色的文字是我们输入/发送到Postfix的）</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid"><FONT color=blue>telnet localhost 25</FONT>
Trying 127.0.0.1...
Connected to localhost.localdomain (127.0.0.1).
Escape character is '^]'.
220 mail.extmail.org ESMTP Postfix - by extmail.org
<FONT color=blue>ehlo demo.domain.tld</FONT>
250-mail.extmail.org
250-PIPELINING
250-SIZE 10240000
250-VRFY
250-ETRN
250-AUTH LOGIN PLAIN
250-AUTH=LOGIN PLAIN
250-ENHANCEDSTATUSCODES
250-8BITMIME
250 DSN
<FONT color=blue>auth login</FONT>
334 VXNlcm5hbWU6
<FONT color=blue>cG9zdG1hc3RlckBleHRtYWlsLm9yZw==</FONT>
334 UGFzc3dvcmQ6
<FONT color=blue>ZXh0bWFpbA==</FONT>
235 2.0.0 Authentication successful
<FONT color=blue>quit</FONT>
221 2.0.0 Bye
</PRE>
<P>最后出现235 Authentication Successful 表明认证成功了。 </P>
<H3><A name=imap></A>安装Courier-IMAP</H3>
<P>用以下命令安装courier-imap的rpm包，默认的courier-authlib及courier-imap都会增加系统自启动设置，因此下一次服务器启动将自动启动相应的authlib及POP3服务</P>
<DIV class=line>rpm -ivh RPMS/courier-imap-4.1.0-1hzq.i386.rpm </DIV><BR>
<DIV class=sm_title>配置courier-imap</DIV>
<P>由于Courier-imap的IMAP目录是按UTF-7编码的，<B><I>ExtMail目前还没有正式支持IMAP目录，因此需要屏蔽IMAP，只提供pop3服务</I></B>。而就目前的使用情况来看，IMAP使用的非常少，绝大部分OutLook/Foxmail用户都习惯使用POP3而非IMAP。</P>
<DIV class=line>vi /usr/lib/courier-imap/etc/imapd</DIV>
<P>将如下这行配置：</P>
<DIV class=line>IMAPDSTART=YES </DIV>
<P>替换成为：</P>
<DIV class=line>IMAPDSTART=NO</DIV>
<DIV class=line>vi /usr/lib/courier-imap/etc/imapd-ssl</DIV>
<P>再将如下配置：</P>
<DIV class=line>IMAPDSSLSTART=YES </DIV>
<P>替换成为：</P>
<DIV class=line>IMAPDSSLSTART=NO </DIV>
<P>然后重新启动courier-imap：</P>
<DIV class=line>/etc/init.d/courier-imap start </DIV><BR>
<DIV class=sm_title>测试POP3</DIV>
<P>请按如下步骤输入pop3命令测试其是否正常工作，注意蓝色的信息是我们输入到POP3服务器的(请首先登录extman自行建立test@extmail.org用户，密码:extmail)</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid"><FONT color=blue>telnet localhost 110</FONT>
Trying 127.0.0.1...
Connected to localhost.localdomain (127.0.0.1).
Escape character is '^]'.
+OK Hello there.
<FONT color=blue>user test@extmail.org</FONT>
+OK Password required.
<FONT color=blue>pass extmail</FONT>
+OK logged in.
<FONT color=blue>list</FONT>
+OK POP3 clients that break here, they violate STD53.
.
<FONT color=blue>quit</FONT>
+OK Bye-bye.
Connection closed by foreign host.
</PRE>
<H3><A name=filter></A>反病毒/内容过滤配置</H3>
<P>反病毒及内容过滤器是依赖Amavisd-new软件包，它是一个多功能的过滤器，能与杀毒软件及内容过滤软件（如SpamAssassin）结合，通用性较强。</P>
<H4><A name=filter_prepare></A>安装依赖的Perl包</H4>
<P>首先我们要确保系统自带的perl-Net-DNS软件包被删除干净，因为该包的版本较低（0.48），有已知的bug，所以必须替换成本文档提供的新版（0.5x），输入如下命令：</P>
<DIV class=line>rpm -e --nodeps perl-Net-DNS </DIV>
<P>Amavisd-new 
及SpamAssassin需要依赖大量的第三方perl软件包，下列要安装的部分RPM在上述的操作中已经安装了，为了给出较明确的依赖关系，我们依然将这些包的名称列出，<B><I>如果安装时提示有安装包已安装过，或者提示冲突，请不必惊慌</I></B>。请安装如下的RPM软件包：</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">rpm -ivh RPMS/perl-Digest-SHA1-2.07-5.i386.rpm
rpm -ivh RPMS/perl-Digest-HMAC-1.01-2ext.i386.rpm
rpm -ivh RPMS/perl-Net-IP-1.24-2ext.i386.rpm
rpm --nodeps -ivh RPMS/perl-Net-DNS-0.57-1hzq.i386.rpm
rpm -ivh RPMS/perl-Time-HiRes-1.72-2ext.i386.rpm
rpm -ivh RPMS/perl-HTML-Tagset-3.03-30.noarch.rpm
rpm -ivh RPMS/perl-HTML-Parser-3.35-6.i386.rpm    
rpm -ivh RPMS/perl-libwww-perl-5.79-5.noarch.rpm
rpm -ivh RPMS/spamassassin-3.1.9-1.el4.i386.rpm
rpm -ivh RPMS/perl-IO-stringy-2.110-2ext.i386.rpm
rpm -ivh RPMS/perl-IO-Multiplex-1.08-2ext.i386.rpm
rpm -ivh RPMS/perl-Net-SSLeay-1.30-1.ext.i386.rpm
rpm -ivh RPMS/perl-IO-Socket-SSL-0.97-2ext.i386.rpm
rpm -ivh RPMS/perl-Net-Server-0.93-2ext.i386.rpm
rpm -ivh RPMS/perl-TimeDate-1.16-2ext.i386.rpm
rpm -ivh RPMS/perl-MailTools-1.67-2ext.i386.rpm
rpm -ivh --force RPMS/perl-MIME-Base64-3.05-2ext.i386.rpm
rpm -ivh RPMS/perl-Convert-BinHex-1.119-2ext.i386.rpm
rpm -ivh RPMS/perl-MIME-tools-5.418-2ext.i386.rpm
rpm -ivh RPMS/perl-BerkeleyDB-0.26-2ext.i386.rpm
rpm -ivh RPMS/perl-Convert-TNEF-0.17-2ext.i386.rpm
rpm -ivh RPMS/perl-Convert-UUlib-1.051-2ext.i386.rpm
rpm -ivh RPMS/perl-Compress-Zlib-1.41-2ext.i386.rpm
rpm -ivh RPMS/perl-Archive-Zip-1.23-1ext.i386.rpm
rpm -ivh RPMS/perl-IO-Zlib-1.04-2ext.i386.rpm
rpm -ivh RPMS/perl-Archive-Tar-1.38-1ext.i386.rpm
rpm -ivh RPMS/arc-5.21o-2ext.i386.rpm
rpm -ivh RPMS/zoo-2.10-10ext.i386.rpm
rpm -ivh RPMS/unarj-2.65-50ext.i386.rpm
export LANG=C
rpm -ivh RPMS/amavisd-new-2.5.4-1ext.i386.rpm
mkdir -p /var/amavis/tmp /var/amavis/db
chown amavis.amavis /var/amavis/tmp /var/amavis/db
chmod 777 –R /var/amavis
chown amavis.amavis /var/spool/vscan/db/
chkconfig --add amavisd
</PRE>
<H4>修改amavisd.conf</H4>
<P>修改的主要参数如下，请逐一对照后修改：</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">$max_servers = 10;
$sa_spam_subject_tag = '[SPAM] ';
$mydomain = 'mail.extmail.org';
$myhostname = 'mail.extmail.org';
@local_domains_maps = qw(.);
$sa_tag2_level_deflt = 5.0;
$sa_kill_level_deflt = 5.0;
</PRE>
<DIV class=sm_title>注意事项：</DIV>
<P>上述$mydomain参数与$myhostname参数相同，主要是为了方便之后的病毒/垃圾汇报邮件发给系统管理员时，能投递到本地的别名里，再转交到虚拟域的特定用户。</P>
<P>增加如下参数（默认amavisd.conf没有）：</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">$sa_spam_modifies_subj = 0; # don't modify subject
$remove_existing_x_scanned_headers= 1; # remove existing headers
$remove_existing_spam_headers = 1;
</PRE>
<H4>配置SpamAssassin</H4>
<P>Amavisd-new 通过Mail::SpamAssassin 
模块来调用SA的功能，因此这里配置SA和常规配置SA软件有些区别，主要集中在修改local.cf文件上。</P>
<P>编辑/etc/mail/spamassassin/local.cf文件</P>
<DIV class=line>vi /etc/mail/spamassassin/local.cf</DIV>
<P>将其内容修改为：</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">report_safe             1
use_bayes               0
auto_learn              0
bayes_auto_expire       1
skip_rbl_checks         1
use_razor2              0
use_dcc                 0
use_pyzor               0
dns_available           no
</PRE>
<DIV class=sm_title>增加Chinese_rules.cf支持</DIV>
<P>Chinese_rules.cf是教育科研网的反垃圾邮件小组对大量垃圾邮件和正常邮件进行分析后得出的一个关键字/分数规则集，用于处理中文（简体）垃圾邮件还是比较有效的。这里我们通过如下命令增加到系统：</P>
<DIV class=line>wget -N -P /usr/share/spamassassin 
www.ccert.edu.cn/spam/sa/Chinese_rules.cf </DIV>
<P>由于该规则每周更新一次，为了达到最好效果，最好在crontab里增加自动更新的内容，输入：</P>
<DIV class=line>/usr/bin/crontab -e </DIV>
<P>然后输入如下的内容：</P>
<DIV class=line>0 0 1 * * wget -N -P /usr/share/spamassassin 
www.ccert.edu.cn/spam/sa/Chinese_rules.cf; /etc/init.d/amavisd restart </DIV>
<P>存盘退出即可。最后运行以下调试命令以确认amavisd没有错误：</P>
<DIV class=line>/usr/sbin/amavisd debug </DIV>
<P>如果没有异常提示或报错退出则表示一切都正常，按ctrl+c终止，然后正常启动，若提示pid不存在等错误，不必理会，只要最后启动成功即可： </P>
<DIV class=line>service amavisd start chkconfig amavisd on </DIV>
<H3><A name=filter_clamav></A>安装ClamAV</H3>执行如下命令： <PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">rpm -ivh RPMS/ clamav-db-0.92-2.ext.i386.rpm
rpm -ivh RPMS/ clamav-0.92-2.ext.i386.rpm
rpm -ivh RPMS/ clamd-0.92-2.ext.i386.rpm
</PRE><BR>
<P>编辑/etc/clamd.conf文件，去掉 'LocalSocket /var/run/clamav/clamd.sock'的注释，并注释掉 
'TCPSocket 3310'，我们将使用unix socket而不是TCP，两者不可并存。修改完毕后，保存，变动内容见下：</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid"># Path to a local socket file the daemon will listen on.
# Default: disabled
LocalSocket /var/run/clamav/clamd.sock

#TCPSocket 3310
</PRE>
<P>将clamav加到amavis运行组里，并调整目录权限，否则clamav将无法扫描amavisd-new产生的临时文件</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">gpasswd -a clamav amavis
usermod -G amavis clamav
chown amavis.amavis /var/spool/vscan
chmod 750 /var/spool/vscan
chown amavis.amavis /var/spool/vscan/tmp
chmod 750 /var/spool/vscan/tmp
</PRE>
<P>默认的/var/spool/vscan 目录属性是：</P>
<DIV class=line>rwx------ amavis.root </DIV>
<P>对于clamav用户而言，则无任何权限访问该目录，因此maillog里amavisd-new会提示:</P>
<DIV class=line style="LINE-HEIGHT: 150%">May 19 08:38:53 as3 amavis[1752]: 
(01752-01) ask_av (ClamAV-clamd) FAILED - unexpected result: 
/var/spool/vscan/tmp/amavis-20050519T083853-01752/parts: Access denied. 
ERROR\n<BR>May 19 08:38:53 as3 amavis[1752]: (01752-01) WARN: all primary virus 
scanners failed, considering backups </DIV><BR>
<DIV class=sm_title>启动ClamAV及freshclam</DIV><BR><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">service clamd start
freshclam --daemon
</PRE>
<DIV class=sm_title>将freshclam增加到自启动</DIV>
<P>输入如下命令，即可使freshclam一开机就实现自启动</P>
<DIV class=line>echo "/usr/bin/freshclam --daemon" &gt;&gt; 
/etc/rc.d/rc.local</DIV>
<H4><A 
name=filter_amavis></A>配置Amavisd与Clamav结合</H4>为了使Amavisd-new能与clamav结合，需要修改/etc/amavisd.conf文件，打开clamav的支持代码，编辑/etc/amavisd.conf文件，大概在360行左右，去掉clamav的支持代码注释，并将socket路径改为/var/run/clamav/clamd.sock，如下： 
<PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">['ClamAV-clamd',
  \&amp;ask_daemon, ["CONTSCAN {}\n", "/var/run/clamav/clamd.sock"],
  qr/\bOK$/, qr/\bFOUND$/,
  qr/^.*?: (?!Infected Archive)(.*) FOUND$/ ],
</PRE>在154行左右，修改投递/拦截的方法：<BR><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">$final_virus_destiny      = D_DISCARD;
$final_banned_destiny     = D_BOUNCE;
$final_spam_destiny       = D_PASS;
$final_bad_header_destiny = D_PASS;
</PRE>
<P>注意上述4个设置中，对spam（垃圾邮件）默认会直接反弹（BOUNCE），现在修改为继续投递（PASS）但在信头中增加相关X-Spam-Status信息等。这样可以很方便的在extmail中设置将被标记为垃圾邮件的mail投递到“垃圾邮件箱”中，便于用户翻查。</P>
<H4>增加邮件别名</H4>编辑/etc/postfix/aliases，增加如下信息，<B>注意：</B>默认的aliases数据库里已有一条virusalert的别名，所以请删除，再输入下面的别名记录，并确保所有记录都是唯一的： 
<PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">virusalert:    root
spam.police:   root
postfix:       test@extmail.org
</PRE><BR>保存并执行<B><I>newaliases</I></B>命令生成新的别名数据库，这样所有的重新启动amavisd： 
<DIV class=line>/etc/rc.d/init.d/amavisd restart </DIV>
<H4><A name=filter_mta></A>配置Postfix 集成amavisd-new</H4>vi 
/etc/postfix/master.cf<BR>增加如下内容： <PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">127.0.0.1:10025 inet    n       -       n       -       -       smtpd
    -o content_filter=
    -o local_recipient_maps=
    -o relay_recipient_maps=
    -o smtpd_restriction_classes=
    -o smtpd_client_restrictions=
    -o smtpd_helo_restrictions=
    -o smtpd_sender_restrictions=
    -o smtpd_recipient_restrictions=permit_mynetworks,reject
    -o mynetworks=127.0.0.0/8
    -o strict_rfc821_envelopes=yes
    -o smtpd_error_sleep_time=0
    -o smtpd_soft_error_limit=1001
    -o smtpd_hard_error_limit=1000
    -o receive_override_options=
</PRE>
<P>编辑/etc/postfix/main.cf</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid"># Content-Filter
content_filter = smtp:[127.0.0.1]:10024
receive_override_options = no_address_mappings
</PRE>
<P><B>注意：</B>receive_override_options 
这里必须增加，禁止地址展开/影射，否则如果遇到别名的时候会引起冗余邮件的产生。</P>
<P>保存后service postfix restart </P>
<H4><A name=filter_test></A>测试Clamav</H4>然后输入如下命令： 每输入一行后等待1秒左右： <PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid"><FONT color=blue>telnet localhost 25</FONT>
Trying 127.0.0.1...
Connected to localhost.localdomain (127.0.0.1).
Escape character is '^]'.
220 mail.extmail.org ESMTP Postfix - by extmail.org
<FONT color=blue>mail from:&lt;postmaster@extmail.org&gt;</FONT>
250 2.1.0 Ok
<FONT color=blue>rcpt to:&lt;test@extmail.org&gt;</FONT>
250 2.1.5 Ok
<FONT color=blue>data</FONT>
354 End data with <CR><LF>.<CR><LF>
<FONT color=blue>X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*
.</FONT>
250 2.0.0 Ok: queued as BC24E85260
<FONT color=blue>quit</FONT>
221 2.0.0 Bye
Connection closed by foreign host.
</PRE>
<P>在邮件日志里，应该有相应的信息出现：</P>
<DIV class=line>Mar 22 06:43:15 localhost amavis[15405]: (15405-01) Blocked 
INFECTED (Eicar-Test-Signature), [192.168.0.235] <POSTMASTER@EXTMAIL.ORG>-&gt; 
<TEST@EXTMAIL.ORG>, quarantine: virus-mI6vbjkWZ2Tz, Message-ID: 
&lt;003401c88c1a$74706360$eb00a8c0@nbk00045&gt;, mail_id: mI6vbjkWZ2Tz, Hits: -, 
size: 1757, 474 ms</DIV>
<P>如果看到类似这样的日志，表明Clamav+Amavisd-new工作正常。</P>
<H3><A name=slockd></A>Spam Locker配置与安装</H3>
<H4>安装需求</H4><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">支持Linux / BSD或Solaris，HP-UX等操作系统
Perl 5.6+，建议Perl 5.8.0以上
Net::DNS
POSIX
Fcntl
Digest::MD5
Digest::SHA1
Digest::HMAC
Net::IP
</PRE>
<H4><A name=slockd_prepare></A>解包软件</H4>
<DIV class=line>tar -zxvf src/slockd-0[1][1].10.tar.gz -C src<BR>cp -r 
src/slockd-0.10 /usr/local/slockd </DIV>
<H4><A name=spam_prepare></A>安装相关Perl模块</H4>
<P>由于slockd是以smtp特征检测为主的软件，因此很大程度依赖dns库，必须安装Net::DNS库才能正常工作。除此外还有诸如HMAC，MD5及SHA1, 
Net-IP等模块。</P>
<P>执行以下命令安装需要的模块，<B>注意：</B>这些模块在上文安装Amavisd-new时已经安装过，这里重复是为了强调slockd依赖这些软件包</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">rpm -ivh RPMS/perl-Digest-SHA1-2.07-5.i386.rpm
rpm -ivh RPMS/ perl-Digest-HMAC-1.01-2ext.i386.rpm
rpm -ivh RPMS/ perl-Net-IP-1.24-2ext.i386.rpm
rpm -ivh --nodeps RPMS/perl-Net-DNS-0.57-1hzq.i386.rpm
</PRE>
<H4>配置resolv.conf</H4>
<P>请确认/etc/resolv.conf里的dns服务器是离你的邮件服务器最近，速度最快的dns 
server，slockd很依赖dns的好坏，因此给系统配置一个快速的dns能大幅度提高处理速度。以下给出一个配置仅供参考：</P>
<DIV class=line>nameserver 202.96.128.68 </DIV>
<P>上述dns服务器是广东电信的DNS服务器，对于非广东朋友，请改为离你最近的dns 服务器ip</P>
<P>如果可能的话，请配置一个简单的bind9，成为本地的dns cache 
server，可以获得最高性能。这里略过这一步骤，但您必须确保dns的配置是正确并且可靠的，否则slockd将不能工作！</P>
<H4><A name=slockd_test></A>启动/测试</H4>执行：<BR>
<DIV class=line>/usr/local/slockd/slockd-init start</DIV>
<P>此时slockd将启动，并进入非daemon方式的监听模式，接受来自10030端口的请求，命令行下将显示如下调试信息：</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">Starting spam locker daemon: slockd
starting child 2908
starting child 2909
08-01 12:34:40 [2908]: Loading APF::Plugin::localctrl
08-01 12:34:40 [2909]: Loading APF::Plugin::localctrl
08-01 12:34:40 [2908]: Loading APF::Plugin::anvil
08-01 12:34:40 [2908]: Loading APF::Plugin::fqdn
08-01 12:34:40 [2909]: Loading APF::Plugin::anvil
08-01 12:34:40 [2908]: Loading APF::Plugin::dnsbl
08-01 12:34:40 [2909]: Loading APF::Plugin::fqdn
08-01 12:34:40 [2909]: Loading APF::Plugin::dnsbl
08-01 12:34:40 [2908]: Loading APF::Plugin::hostname
08-01 12:34:40 [2909]: Loading APF::Plugin::hostname
</PRE>
<P>打开另一个ssh/终端窗口，进入/usr/local/slockd/tools 目录，输入：</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">perl policy_sig -h localhost -p 10030 --helo FOOBAR \
--ip 192.168.0.1 --from test@foo.com --to test@bar.com
</PRE>
<P>此时，程序应该返回如下错误信息：</P>
<DIV class=line>action=504 &lt;FOOBAR&gt;: rejected, see 
http://bl.extmail.org/cgi/why?fqdn </DIV>
<P>这表示slockd初步的正常工作了。 </P>
<H4>后台方式运行slockd</H4>
<P>调试正确后，必须将slockd配置成后台服务进程（Daemon Process）。vi /usr/local/slockd/config/main.cf 
将如下两个配置的注释去掉： <PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid"># uncomment the following line if you need to daemonize
setsid          1

## logging
log_file        /var/log/slockd.log
</PRE>
<P>然后在运行slockd的命令行窗口按ctrl+c，关闭刚才运行的slockd。或者在另一个命令行窗口输入如下命令以杀死slockd进程：</P>
<DIV class=line>killall slockd </DIV>
<P>然后执行：</P>
<DIV class=line>/usr/local/slockd/slockd-init start</DIV>
<H4>自启动</H4>
<P>输入如下的命令，将slockd启动加入到系统里，这样下一次服务器重新启动，就可以自动执行slockd了。</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">echo "/usr/local/slockd/slockd-init start" &gt;&gt; /etc/rc.d/rc.local
</PRE>
<H4><A name=slockd_mta></A>配置Postfix</H4>
<P>slockd调试正常后，必须配置postfix以使其打开对slockd的支持，编辑/etc/postfix/main.cf，将 
check_policy_service inet:127.0.0.1:10030 这一行记录增加到smtpd_recipient_restrictions 
里，例如：</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">smtpd_recipient_restrictions =
  permit_mynetworks,
  permit_sasl_authenticated,
  reject_non_fqdn_hostname,
  reject_non_fqdn_sender,
  reject_non_fqdn_recipient,
  reject_unauth_destination,
  reject_unauth_pipelining,
  reject_invalid_hostname,
  <FONT color=blue>check_policy_service inet:127.0.0.1:10030</FONT>
</PRE>
<P>最后，重新启动postfix以使配置生效</P>
<DIV class=line>service postfix restart </DIV>
<DIV class=sm_title>注意事项：</DIV>
<P>上述配置是将slockd的查询放到最后，这也是进一步提高资源利用律的办法，因为有部分功能postfix已实现了，所以就先由postfix检测，如果检测不到再由slockd完成。</P>
<H3><A name=last_test></A>最终测试</H3>
<P>现在通过简单的email收发来确认系统是否正常。</P>
<DIV class=sm_title>发送测试邮件</DIV>
<P>输入以下命令，通过telnet方式给test@extmail.org发送一封测试信件</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid"><FONT color=blue>telnet localhost 25</FONT>
Trying 127.0.0.1...
Connected to localhost.localdomain (127.0.0.1).
Escape character is '^]'.
220 mail.extmail.org ESMTP Postfix - by extmail.org
<FONT color=blue>helo demo.extmail.org</FONT>
250 mail.extmail.org
<FONT color=blue>mail from:&lt;test@extmail.org&gt;</FONT>
250 2.1.0 Ok
<FONT color=blue>rcpt to:&lt;test@extmail.org&gt;</FONT>
250 2.1.5 Ok
<FONT color=blue>data</FONT>
354 End data with <CR><LF>.<CR><LF>
<FONT color=blue>Subject: Hello World

Hello World!
.</FONT>
250 2.0.0 Ok: queued as 3E47685269
<FONT color=blue>quit</FONT>
221 2.0.0 Bye
Connection closed by foreign host.
</PRE>
<P>此时通过另一个命令行窗口，观察maillog，命令为：</P>
<DIV class=line>tail -f /var/log/maillog</DIV>
<P>将看到如下信息：</P>
<DIV class=line>Aug 1 12:51:06 centos postfix/qmgr[3017]: 041718526B: 
from=<TEST@EXTMAIL.ORG>, size=833, nrcpt=1 (queue active)<BR>Aug 1 12:51:06 
centos postfix/smtpd[3032]: disconnect from centos[127.0.0.1]<BR>Aug 1 12:51:06 
centos amavis[2890]: (02890-01) Passed CLEAN, [127.0.0.1] 
<TEST@EXTMAIL.ORG>-&gt; <TEST@EXTMAIL.ORG>, Message-ID: 
&lt;20060801165039.3E47685269@mail.extmail.org&gt;, mail_id: N8nxpoRn4Hlq, Hits: 
0.107, 11561 ms<BR>Aug 1 12:51:06 centos postfix/smtp[3043]: 3E47685269: 
to=<TEST@EXTMAIL.ORG>, relay=127.0.0.1[127.0.0.1], delay=27, dsn=2.6.0, 
status=sent (250 2.6.0 Ok, id=02890-01, from MTA([127.0.0.1]:10025): 250 2.0.0 
Ok: queued as 041718526B)<BR>Aug 1 12:51:06 centos postfix/qmgr[3017]: 
3E47685269: removed<BR>Aug 1 12:51:06 centos postfix/pipe[3035]: 041718526B: 
to=<TEST@EXTMAIL.ORG>, relay=maildrop, delay=0, dsn=2.0.0, status=sent 
(delivered via maildrop service)<BR>Aug 1 12:51:06 centos postfix/qmgr[3017]: 
041718526B: removed<BR></DIV>
<P>上述日志表示邮件经过了amavisd-new的扫描，并且已经通过maildrop投递到用户的maildir了。至此，整个ExtMail Solution 
的安装配置已经基本告一段落。对于需要进行高级调整的朋友，请留意本文附录的备注。备注的内容将不断更新，敬请留意。</P>
<H3><A name=extra></A>补充配置</H3>
<P>以下是补充的ExtMail 
Solution有关文档，主要是为希望进一步了解mail系统运行，并提高extmail效能的朋友准备，对于初学者而言，建议要先打好基础再进行测试。</P>
<H4><A name=#extra_fcgi></A>增加FCGI支持</H4>
<P>为extmail增加FCGI的支持，主要是为了获得优异的web效能，克服CGI不能应付大量访问及低效率的缺陷。根据我们的测试，CGI模式下的页面效率只有FCGI下的1/10~1/100，因此建议有条件的用户还是使用FCGI。日后ExtMail 
Solution的web CGI程序将全部都支持FCGI。</P>
<DIV class=sm_title>安装mod_fastcgi</DIV>
<P>mod_fastcgi 是针对Apache Web服务器的FCGI支持模块，下载地址： <A 
href="http://www.fastcgi.com/dist/mod_fastcgi-2.4.2.tar.gz">http://www.fastcgi.com/dist/mod_fastcgi-2.4.2.tar.gz</A> 
</P>
<P>编译指令：</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">wget http://www.fastcgi.com/dist/mod_fastcgi-2.4.2.tar.gz
tar xfz mod_fastcgi-2.4.2.tar.gz
cd mod_fastcgi-2.4.2
cp Makefile.AP2 Makefile
make top_dir=/etc/httpd install
</PRE>
<DIV class=sm_title>安装perl-FCGI</DIV>
<P>除了Apache需要FCGI的支持外，extmail也需要相应的perl-FCGI模块。用以下命令安装： </P>
<DIV class=line>rpm -ivh RPMS/perl-FCGI-0.67-3ext.i386.rpm </DIV>
<P>接下来将配置Apache，将如下的信息增加到/etc/httpd/conf/vhost_extmail.conf的虚拟主机配置之后：</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">LoadModule fastcgi_module modules/mod_fastcgi.so

&lt;Ifmodule mod_fastcgi.c&gt;
FastCgiExternalServer /usr/bin/dispatch.fcgi -host 127.0.0.1:8888
&lt;/Ifmodule&gt;
</PRE>
<P>同时，去掉如下行：</P>
<DIV class=line>ScriptAlias /extmail/cgi/ /var/www/extsuite/extmail/cgi/ </DIV>
<P>改为：</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">Alias /extmail/cgi/ /usr/bin/dispatch.fcgi/
&lt;Location "/extmail/cgi"&gt;
SetHandler fastcgi-script
&lt;/Location&gt;
</PRE>
<P>然后编辑/var/www/extsuite/extmail/dispatch-init文件，修改如下：</P>
<DIV class=line>BASE=/var/www/extsuite/extmail </DIV>
<P>最后启动fastcgi server：</P>
<DIV class=line>/var/www/extsuite/extmail/dispatch-init start </DIV>
<P>如果没有意外将启动10个dispatch.fcgi守护进程，可以通过以下命令将启动命令加到rc.local中，实现自启动：</P><PRE style="BORDER-RIGHT: #ccc 1px solid; BORDER-TOP: #ccc 1px solid; BORDER-LEFT: #ccc 1px solid; BORDER-BOTTOM: #ccc 1px solid">echo "/var/www/extsuite/extmail/dispatch-init start" &gt;&gt; /etc/rc.d/rc.local
</PRE>
<H3><A name=end></A>结束语</H3>
<P>通过此文档，读者应该能够较容易地架设一个功能较齐全的电子邮件系统。当使用一段时间后，用户将发现这个系统还有很多比较粗糙的地方，不尽人意。日后，本文档将继续保持更新，逐步将一些高级的设置方法公布出来，争取ExtMail 
Solution更加完整，力求完美。 </P>
<H3><A name=bugs></A>已知Bugs</H3>
<P>整个ExtMail Solution尽力将Opensource软件的优点发挥到极至，但免不了还是有bug。以下是几个已知的问题：</P>
<DIV class=sm_title>WebMail</DIV>
<UL>
  <LI>删除/新增邮件时左帧数字不会变更 
  <LI>不能处理少量违反RFC的邮件 
  <LI>在某些版本Apache下偶尔出现会话失效问题 
  <LI>还不支持IMAP创建的中文子目录 </LI></UL>
<DIV class=sm_title>Amavisd-new</DIV>
<UL>
  <LI>退信模板还是英文的 
  <LI>产生的汇报信息不够友好 </LI></UL>
<DIV class=sm_title>Spam Locker</DIV>
<UL>
  <LI>错误识别一些配置异常的mail服务器 
  <LI>与内容过滤器结合不够紧密 
  <LI>hostname模块易造成较多误伤 </LI></UL>
<H3><A name=todo></A>TODO 列表</H3>
<UL>
  <LI>支持SMTP 及 POP3/IMAP的TLS/SSL加密 
  <LI>HTTP及SMTP/POP3等CA证书的配置 
  <LI>更精细的Anti-Spam策略及关键字过滤 
  <LI>系统安全配置（基于iptables） </LI></UL>&gt; </BODY></HTML>
