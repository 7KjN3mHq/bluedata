## Redhat 9 and CentOS 3.x setting
ln -s /usr/kerberos/include/com_err.h /usr/include/
ln -s /usr/kerberos/include/profile.h /usr/include/
ln -s /usr/kerberos/include/krb5.h /usr/include/

## install
tar jxvf httpd-2.2.3.tar.bz2
tar zxvf mod_limitipconn-0.22.tar.gz
cd httpd-2.2.3
patch -p1 < ../mod_limitipconn-0.22/apachesrc.diff
./buildconf

./configure \
--prefix=/usr/local/apache \
--enable-mods-shared=most \
--enable-so \
--enable-rewrite=shared \
--enable-deflate=shared \
--enable-forward=shared
make
make install
cd ..

## install mod_limitipconn
cd mod_limitipconn-0.22
PATH=/usr/local/apache/bin:$PATH make install
cd ..

## install mod_evasive
tar zxvf mod_evasive_1.10.1.tar.gz
cd mod_evasive
vi mod_evasive20.c
#define MAILER "/usr/sbin/sendmail -t %s"
/usr/local/apache/bin/apxs -cia mod_evasive20.c
cd ..

## install cronolog
tar zxvf cronolog-1.6.2.tar.gz
cd cronolog-1.6.2
./configure
make
make install


## configuration
mkdir -p /var/log/apache/dos
vi /usr/local/apache/conf/httpd.conf
LoadModule authn_file_module modules/mod_authn_file.so
LoadModule authz_host_module modules/mod_authz_host.so
LoadModule authz_user_module modules/mod_authz_user.so
LoadModule auth_basic_module modules/mod_auth_basic.so
LoadModule deflate_module modules/mod_deflate.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule mime_module modules/mod_mime.so
LoadModule status_module modules/mod_status.so
LoadModule autoindex_module modules/mod_autoindex.so
LoadModule dir_module modules/mod_dir.so
LoadModule alias_module modules/mod_alias.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule limitipconn_module modules/mod_limitipconn.so
LoadModule evasive20_module   modules/mod_evasive20.so
LoadModule php4_module        modules/libphp4.so

User vpopmail
Group vchkpw

ServerAdmin bluedata@xnjcw.com

#Order deny,allow
#Deny from all

ErrorLog "|/usr/local/sbin/cronolog /var/log/apache/error_log.%Y%m%d"
CustomLog "|/usr/local/sbin/cronolog /var/log/apache/access_log.%Y%m%d" combined

Include conf/extra/httpd-mpm.conf
Include conf/extra/httpd-autoindex.conf
Include conf/extra/httpd-info.conf
Include conf/extra/httpd-vhosts.conf
Include conf/extra/httpd-default.conf
## Add
Include conf/extra/httpd-modules.conf

vi /usr/local/apache/conf/extra/httpd-modules.conf
<IfModule mod_deflate.c>
    DeflateCompressionLevel 9
    AddOutputFilterByType DEFLATE text/html text/plain text/xml application/x-httpd-php
    AddOutputFilter DEFLATE css js
</ifmodule>

<IfModule mod_limitipconn.c>
    <Location />
        MaxConnPerIP 8
        NoIPLimit image/* text/css application/x-shockwave-flash application/x-javascript
    </Location>
</IfModule>

<IfModule mod_evasive20.c>
    DOSHashTableSize    3097
    DOSPageCount        2
    DOSSiteCount        50
    DOSPageInterval     1
    DOSSiteInterval     1
    DOSBlockingPeriod   10
    DOSEmailNotify      bluedata@xnjcw.com
    DOSSystemCommand    "/sbin/iptables -I INPUT -i eth0 -s %s -p tcp --dport 80 -j DROP"
    DOSLogDir           "/var/log/apache/dos"
    DOSWhitelist        222.212.0.0/16
</IfModule>

chmod +s /sbin/iptables

vi /usr/local/apache/conf/extra/httpd-mpm.conf
PidFile /var/run/httpd.pid
LockFile /var/lock/subsys/accept.lock
ServerLimit        128
MaxClients         128
MaxRequestsPerChild  0

vi /usr/local/apache/conf/extra/httpd-autoindex.conf
IndexOptions FancyIndexing HTMLTable VersionSort NameWidth=*

vi /usr/local/apache/conf/extra/httpd-info.conf
Allow from 127.0.0.1 219.153.32.197 222.212.0.0/16
ExtendedStatus On

vi /usr/local/apache/conf/extra/httpd-default.conf
Timeout 10
KeepAlive Off
ServerTokens Prod

vi /usr/local/apache/conf/extra/httpd-vhosts.conf
<VirtualHost *:80>
DocumentRoot /home/xnjcw_new/public_html
ErrorDocument 404 http://www.jc001.cn/discount/index.html
ServerName *
</VirtualHost>
Include conf/extra/httpd-vhosts-*.conf

vi /usr/local/apache/conf/extra/httpd-vhosts-main.conf
## Add set

vi /etc/crontab
5 0 * * * root find /var/log/apache -type f -mtime +2 -exec rm -f {} \;

mv /usr/local/apache/bin/apachectl /etc/rc.d/init.d/httpd
vi /etc/rc.d/init.d/httpd
## Add
#chkconfig: 345 85 15
#description: Starts and stops httpd.
unset LANG
LC_ALL=C
export LC_ALL

chmod +x /etc/rc.d/init.d/httpd
chkconfig --del httpd && chkconfig --add httpd
ln -s /etc/rc.d/init.d/httpd /usr/local/apache/bin/apachectl

vi ~/.bash_profile
PATH=$PATH:$HOME/bin:/usr/local/apache/bin