http://sourceforge.net/projects/dk-milter/
wget http://nchc.dl.sourceforge.net/sourceforge/dk-milter/dk-milter-1.0.2.tar.gz

rpm for centos5:
http://www.topdog-software.com/oss/dk-milter/
wget http://www.topdog-software.com/oss/dk-milter/dk-milter-1.0.2-0.x86_64.rpm

rpm for centos4:
wget http://www.c-corp.net/linux/centos/4/generic/RPMS/i386/dk-milter-0.6.0-1.i386.rpm


yum -y install sendmail-devel
tar zxvf dk-milter-1.0.2.tar.gz
cd dk-milter-1.0.2
sh Build -c
sh Build install
cp obj.Linux.2.6.9-67.0.20.ELsmp.x86_64/dk-filter/dk-filter.8 /usr/share/man/man8/
cd dk-filter
./gentxt.csh default jc001.cn
将公匙记录到 DNS Server 上：
default._domainkey IN TXT "k=rsa; t=y; p=MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBANlTb+AOwFmUi5W2xG+LnHc4S4LjqdEO5fVr3C51oahC+i4u/xUhIlghmWZuHWW0HGi4gskVR/mD7WWt3Y9NbPsCAwEAAQ==" ; ----- DomainKey default for jc001.cn

dig -t txt default._domainkey.jc001.cn

cp default.private /etc/postfix/jc001.cn.key.pem
chmod 600 /etc/postfix/jc001.cn.key.pem

vi /etc/sysconfig/dk-filter
#!/bin/bash
SOCKET="inet:8891@localhost"
CANON="simple"
DOMAIN="jc001.cn"
PRIVATE_KEY="/etc/postfix/jc001.cn.key.pem"
USER=smmsp
HEADER_IGNORE="subject,date,message-id,to"
SELECTOR=$(date +%Y)
FILTER_RULE="bad=r,dns=r,int=r,no=a,miss=r"

vi /etc/init.d/dk-filter
#!/bin/bash

RETVAL=0
prog="dk-filter"

if [ -x /usr/bin/$prog ] ; then
    PROGDIR=/usr/bin
elif [ -x /usr/local/bin/$prog ] ; then
    PROGDIR=/usr/local/bin
else
    exit 0
fi


SOCKET="inet:8891@localhost"
# Source configuration
if [ -f /etc/sysconfig/$prog ] ; then
    . /etc/sysconfig/$prog
fi

start() {
    ulimit -s 2048
    $PROGDIR/$prog -H -h -l -P /var/run/dk-filter.pid   \
        $([ -n "$FILTER_RULE" ] && echo "-C $FILTER_RULE") \
        $([ -n "$DOMAIN" ] && echo "-d $DOMAIN") \
        $([ -n "$SELECTOR" ] && echo "-S $SELECTOR") \
        $([ -n "$PRIVATE_KEY" ] && echo "-s $PRIVATE_KEY") \
        $([ -n "$CANON" ] && echo "-c $CANON") \
        $([ -n "$USER" ] && echo "-u $USER") \
        $([ -n "$HEADER_IGNORE" ] && echo "-o $HEADER_IGNORE") \
        -p $SOCKET
    echo $cmd
    echo

    # Start daemon
    echo  "Starting $prog: [OK]"
    [ -e $SOCKET ] && rm -f $SOCKET
    return $RETVAL
}

stop() {
    # Stop daemon
    echo -n "Shutting down $prog: [OK]"
    killall -9 $prog
    RETVAL=$?
    echo

    [ -e $SOCKET ] && rm -f $SOCKET

    # Stop daemon
    echo -n "Shutting down $prog: "
    killproc $prog
    echo
    [ -e $MX_SOCKET ] && rm -f $MX_SOCKET
}

# See how we were called.
case "$1" in
    start)
    start
    ;;
    stop)
    stop $2
    ;;
    restart)
    stop
    start
    RETVAL=$?
    ;;
    *)
    echo "Usage: $0 {start|stop|restart}"
    exit 1
esac

exit $RETVAL

chmod +x /etc/init.d/dk-filter

/etc/init.d/dk-filter start

vi /etc/postfix/main.cf
smtpd_milters = inet:localhost:8891
non_smtpd_milters = inet:localhost:8891

/usr/bin/dk-filter -A -l -p inet:8891@localhost -d jc001.cn -s /etc/postfix/jc001.cn.key.pem -S default    // 启动dk-filter签名服务

/etc/init.d/postfix restart


wget http://www.c-corp.net/linux/centos/4/i386/generic/SRPMS/dkim-milter-1.2.0-1.src.rpm
rpm -ivh dkim-milter-1.2.0-1.src.rpmcd /usr/src/redhat/SPECS
rpmbuild --bb dkim-milter.spec
cd /usr/src/redhat/RPMS/x86_64
rpm -ivh dkim-milter-1.2.0-1.x86_64.rpm --nodeps

mkdir /etc/dkim-milter
chown dkim-milt.dkim-milt /etc/dkim-milter
chmod 700 /etc/dkim-milter
chgrp postfix /var/run/dkim-milter
chmod 770 /var/run/dkim-milter

wget http://www.topdog-software.com/files/dkim-genkey.sh
chmod +x dkim-genkey.sh
./dkim-genkey.sh -d jc001.cn
mv default.private /etc/dkim-milter/jc001.cn_default.key.pem
chown dkim-milt.dkim-milt /etc/dkim-milter/jc001.cn_default.key.pem

default.txt 的内容加入 dns zone

vi /etc/sysconfig/dkim-milter
USER="dkim-milt"
PORT=local:/var/run/dkim-milter/dkim.sock
SIGNING_DOMAIN="jc001.cn"
SELECTOR_NAME="default"
KEYFILE="/etc/dkim-milter/${SIGNING_DOMAIN}_${SELECTOR_NAME}.key.pem"
SIGNER=yes
VERIFIER=yes
CANON=simple
SIGALG=rsa-sha1
REJECTION="bad=r,dns=t,int=t,no=a,miss=r"
EXTRA_ARGS="-h -l -D"
MILTER_GROUP="postfix"

wget http://www.topdog-software.com/files/dkim-milter -O /etc/init.d/dkim-milter
chkconfig --level 345 dkim-milter on
service dkim-milter start

vi /etc/postfix/main.cf
smtpd_milters = unix:/var/run/dkim-milter/dkim.sock
non_smtpd_milters = unix:/var/run/dkim-milter/dkim.sock

/etc/init.d/postfix restart

test:
Send a message to autorespond+dkim@dk.elandsys.com; the system will return a response to let you know if DKIM is working.


SpamAssassin DKIM
yum install perl-Mail-DKIM
Installing for dependencies: perl-Crypt-OpenSSL-RSA perl-Digest-SHA
yum install perl-Crypt-OpenSSL-Bignum
echo "loadplugin Mail::SpamAssassin::Plugin::DKIM" >> /etc/mail/spamassassin/init.pre
/etc/init.d/amavisd restart