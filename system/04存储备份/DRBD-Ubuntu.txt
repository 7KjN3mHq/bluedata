mysql master / nfs backup node:
eth0 10.36.88.150

nfs master / mysql backup node:
eth0 10.36.88.152

apt-get install nfs-kernel-server
/etc/init.d/nfs-kernel-server stop
sysv-rc-conf nfs-kernel-server off

vi /etc/default/nfs-kernel-server
RPCNFSDCOUNT=32

vi /etc/exports
/data 10.36.88.128/26(rw,no_root_squash,async,no_subtree_check)


apt-get install lvm2

pvcreate /dev/sda7 /dev/sdb /dev/sdc /dev/sdd
vgcreate vg /dev/sda7 /dev/sdb /dev/sdc /dev/sdd
lvcreate -L 250GB -n mysql vg
lvcreate -l 111124 -n data vg


apt-get install drbd8-utils
vi /etc/drbd.d/global_common.conf
global {
  usage-count yes;
}
common {
  protocol C;
}

vi /etc/drbd.d/mysql.res
resource mysql {
  on db1 {
      device    /dev/drbd0;
      disk      /dev/vg/mysql;
      address   10.36.88.150:7788;
      meta-disk internal;
  }
  on db2 {
      device    /dev/drbd0;
      disk      /dev/vg/mysql;
      address   10.36.88.152:7788;
      meta-disk internal;
  }
}

vi /etc/drbd.d/data.res
resource data {
  on db1 {
      device    /dev/drbd1;
      disk      /dev/vg/data;
      address   10.36.88.150:7789;
      meta-disk internal;
  }
  on db2 {
      device    /dev/drbd1;
      disk      /dev/vg/data;
      address   10.36.88.152:7789;
      meta-disk internal;
  }
}

两台机器都执行：
drbdadm create-md mysql
drbdadm create-md data

两台机器都启动：
/etc/init.d/drbd start

在 mysql master 节点上：
drbdadm adjust mysql
drbdsetup /dev/drbd0 primary -o
mkfs -t ext4 /dev/drbd0
mount -t ext4 -o rw,noatime,nodiratime /dev/drbd0 /mysql

在 nfs master 节点上：
drbdadm adjust data
drbdsetup /dev/drbd1 primary -o
mkfs -t ext4 /dev/drbd1
mount -t ext4 -o rw,noatime,nodiratime /dev/drbd1 /data

查看状态：
/etc/init.d/drbd status


安装 MySQL
http://www.percona.com/doc/percona-server/5.5/installation/apt_repo.html
apt-get install percona-server-server-5.5 percona-server-client-5.5
/etc/init.d/mysql stop
sysv-rc-conf mysql off
mv /var/lib/mysql/* /mysql/
chown mysql:mysql /mysql
grep -Ev "^$|#" /usr/share/mysql/my-innodb-heavy-4G.cnf > /etc/mysql/my.cnf
vi /etc/mysql/my.cnf
pid-file        = /var/run/mysqld/mysqld.pid
log-error       = /var/log/mysql/err.log
datadir         = /mysql
connect_timeout = 15
wait_timeout = 3600
max_connections = 500
max_connect_errors = 1844674407370954751
max_heap_table_size = 256M
default-storage-engine = INNODB
tmp_table_size = 256M
log-bin=/var/lib/mysql/mysql-bin
log-bin-index=/var/lib/mysql/mysql-bin.index
long_query_time = 0.25
slow_query_log_file = /var/log/mysql/slow.log
innodb_file_per_table
innodb_buffer_pool_size = 12G
innodb_flush_method = O_DIRECT
innodb_flush_log_at_trx_commit = 2
innodb_log_buffer_size = 4M

cd /mysql
rm -f ib*

/etc/init.d/mysql start


heartbeat 配置：
apt-get install heartbeat
cd /etc/ha.d
vi authkeys
auth 1
1 crc

chmod 600 authkeys

vi ha.cf
mysql master node:
ucast eth0 10.36.88.152
auto_failback off
node db1
node db2
respawn hacluster /usr/lib/heartbeat/ipfail

nfs master node:
ucast eth0 10.36.88.150
auto_failback off
node db1
node db2

#ping 10.36.64.1
#respawn hacluster /usr/lib/heartbeat/ipfail

两台服务器的 /etc/hosts 中都要配置好 ip / hostname 的对应关系。


初次启动时：
vi haresources
mysql master node:
db1 \
IPaddr::10.36.64.2/26/eth0 \
drbddisk::mysql \
Filesystem::/dev/drbd0::/mysql::ext4::rw,noatime,nodiratime \
mysql

nfs master node:
db2 \
IPaddr::10.36.64.3/26/eth0 \
drbddisk::data \
Filesystem::/dev/drbd1::/data::ext4::rw,noatime,nodiratime \
nfs-kernel-server

然后把 haresources 改为：
db1 \  ## 另一个节点修改为 db2
IPaddr::10.36.64.2/26/eth0 \
IPaddr::10.36.64.3/26/eth0 \
drbddisk::mysql \
drbddisk::data \
Filesystem::/dev/drbd0::/mysql::ext4::rw,noatime,nodiratime \
Filesystem::/dev/drbd1::/data::ext4::rw,noatime,nodiratime \
mysql \
nfs-kernel-server

手动切换资源时要注意停止的顺序，例如：
PATH=$PATH:/etc/ha.d/resource.d
/etc/init.d/mysql stop
IPaddr 10.36.64.2/26/eth0 stop
Filesystem /dev/drbd0 /mysql ext4 rw,noatime,nodiratime stop
drbddisk mysql stop


nfs 客户端安装：
nfs-common portmap

写操作测速
dd if=/dev/zero of=test bs=1024k count=4k

读操作测速
dd if=test of=/dev/null


数据库连接测试：
mysql -e "show variables like 'hostname'" | grep hostname | awk '{print $2}'